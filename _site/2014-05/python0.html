
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">
    <title>python的闭包和修饰器 - shengxc's blog</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->

    <link href="http://cdn.bootcss.com/twitter-bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" media="all">
    <link href="http://cdn.bootcss.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" media="all">
    <link href="/assets/themes/havee/css/style.css?body=1" rel="stylesheet" media="all">
    <link href="/assets/themes/havee/css/pygments.css" rel="stylesheet" media="all">
    <link href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" media="all">
    <link href="/assets/themes/havee/css/" rel="stylesheet" media="all">

    <link rel="shortcut icon" href="/favicon.png">
    <link rel="canonical" href="/2014-05/python0.html">
    <!-- fav and touch icons -->
    <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="shengxc's blog ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="shengxc's blog RSS Feed">

  </head>

  <body>
    <!--[if lte IE 9]>
    <div class="alert alert-warning">
      <p>Your Internet Explorer is not supported. Please upgrade your Internet Explorer to version 9+, or use latest <a href="http://www.google.com/chrome/" target="_blank" class="alert-link">Google chrome</a>、<a href="http://www.mozilla.org/firefox/" target="_blank" class="alert-link">Mozilla Firefox</a>.</p>
      <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-us/internet-explorer/use-compatibility-view#ie=ie-8" target="_blank" class="alert-link">turn off "Compatibility view"</a>.</p>
    </div>
    <![endif]-->

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/" title="shengxc's blog">shengxc's blog</a>
      </div>

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav">
          
          
          


  
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  




          <li>
          <form id="search-form" class="form-inline visible-lg" role="form">
            <input type="text" class="form-control input-sm" placeholder="Search" id="query">
          </form>
          </li>
        </ul>

        <ul class="nav navbar-nav navbar-right visible-lg visible-md">
          <li><a href="/rss.xml" target="_blank" title="RSS"><span class="fa fa-rss fa-lg"></span></a></li>
          
          
          
          
          
        </ul>
      </div><!-- /.navbar-collapse -->
    </div>
    </nav>

    <div class="container">
      <div class="content">
        
<div class="row">

  <article class="col-md-9 main-contenter">
    <div id="search-loader" style="display:none;text-align:center">
      <img src="/assets/themes/havee/images/loading.gif">
    </div>
    <div class="page-header">
      <h2>
        python的闭包和修饰器
        
      </h2>
	  <div class="bottom">
		<span class="glyphicon glyphicon-user"></span><p></p>
	    <span class="glyphicon glyphicon-calendar"></span><p>07 May 2014</p>
		<span class="glyphicon glyphicon-folder-open"></span> 
		<span class="glyphicon glyphicon-tags"></span> <a href="/tags.html#python-ref" title="python"><p>python</p></a>
      </div>
    </div>
    <div class="wrapper"><h1 id="section">闭包</h1>
<p><a href="http://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">闭包</a> （<a href="en_wiki">Closure</a>）是引用了自由变量的函数体，该被引用的自由变量将与函数一同存在，即使离开了创造它的环境也不例外。以下代码是一个简单的闭包例子：</p>

<pre><code>#-*-coding:utf-8-*-
def start(x):
  def increment(y):
    return x + y
  return increment
f = start(0) #初始化基数为0的increment函数
print f(1)
print f.__closure__  #一个cell的tuple，每个cell存储闭包所引用的变量
print [cell.cell_contents for cell in f.__closure__]

#output
1
(&lt;cell at 0x7f068d751398: int object at 0x1ff5170&gt;,)
[0] # 装饰器（Decorators） ## 函数装饰器
</code></pre>

<h3 id="section-1">不带参数的装饰器</h3>
<p>python中的函数装饰器是指某些函数以函数作为输入参数，返回被装饰过的函数的形式。下面是一个为函数运行计时的装饰器，该装饰器输出它装饰的函数的开始时间，终止时间以及运行时间。是一个不带输入参数的函数装饰器</p>

<pre><code>#-*-coding:utf-8-*-
import time
def timing(func):
  def inner_func(*args,**kwargs):
    start = time.time()
    print "start at:",start
    func(*args,**kwargs)
    end =time.time()
    print "end at:",end
    print "used:", end - start
  return inner_func
@timing #装饰器语法糖，该语句等价于在定义完add函数之后再加上add=timing(add)
def add(x,y):
  time.sleep(1)
  return x + y
add(1,2)

#output
start at: 1399482192.25
end at: 1399482193.25
used: 1.00104689598
</code></pre>

<h3 id="section-2">带参数的装饰器</h3>
<p>上述计时装饰器输出的函数开始时间和终止时间都难以读懂，因此，可以在装饰器中传输参数，以格式化要输出的时间，代码如下</p>

<pre><code>#-*-coding:utf-8-*-
import time
def timing(time_format):
  def decorator(func):
    def inner_func(*args,**kwargs):
      start = time.time()
      print "start at:",time.strftime(time_format)
      func(*args,**kwargs)
      end =time.time()
      print "end at:",time.strftime(time_format)
      print "used:", end - start
    return inner_func
  return decorator
@timing("%b %d %Y - %H:%M:%S") #timing装饰器传入time_format格式化字符串后依旧是一个以函数作为参数，返回函数的函数，即decorator函数
def add(x,y):
  time.sleep(1)
  return x + y
add(1,2)

#output:
start at: May 08 2014 - 01:30:21
end at: May 08 2014 - 01:30:22
used: 1.00109791756 ## 类装饰器 类装饰器类似于函数装饰器，不过这次，被装饰的不是函数，而是类，因此，类装饰器的形式是输入类，输出类的函数，下面是一个对类中所有函数计时的装饰器函数

#-*-coding:utf-8-*-
import time
from functools import wraps
def timing(time_format,class_name):
  def decorator(func):
    @wraps(func)  #防止func函数的__name__,__doc__,__module__被修改,如果没有这个装饰器，那么func函数上述属性将被修改为inner_func的相应属性，比如func.__name__将会变成"inner_func"，这样，在下面的代码中就无法正确地输出测试时间的函数名了
    def inner_func(*args,**kwargs):
      start = time.time()
      print class_name + "." + func.__name__
      print "\tstart at: %s",time.strftime(time_format)
      func(*args,**kwargs)
      end =time.time()
      print "\tend at:",time.strftime(time_format)
      print "\tused:", end - start
    return inner_func
  return decorator
def class_timing(time_format):
  def decorator(cls):
    for attr in dir(cls):
      if attr.startswith("__"): #对于类中自带的函数，不做任何修改
        continue
      candidate_func = getattr(cls,attr)
      if hasattr(candidate_func,'__call__'):
        setattr(cls,attr,timing(time_format,cls.__name__)(candidate_func)) #将利用timing函数装饰器装饰cls类中可以执行的函数，并将其重新设置回cls类中
    return cls
  return decorator
@class_timing("%b %d %Y - %H:%M:%S")
class calculate:
  def add(self,x,y):
    time.sleep(1)
    return x + y
  def minus(self,x,y):
    time.sleep(1)
    return x - y
c = calculate();
c.add(1,2)
c.minus(1,2)

#output:
calculate.add
	start at: %s May 08 2014 - 02:06:02
	end at: May 08 2014 - 02:06:03
	used: 1.00110793114
calculate.minus
	start at: %s May 08 2014 - 02:06:03
	end at: May 08 2014 - 02:06:04
	used: 1.00110197067
</code></pre>

<p>上述类装饰器class_timing的实现是对类中每一个非自带的可执行对象利用前面定义的函数装饰器依次修饰，并返回被修饰过的类。</p>

<p>参考：<a href="http://blog.jobbole.com/66895/">Python高级特性（2）：Closures、Decorators和functools</a></p>

</div>
    <div class="cc">
      <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">
        <img title="署名-非商业性使用-相同方式共享 4.0 国际" src="/assets/images/CC.png" alt="License"></img>
      </a>
    </div>
    <div class="row status">
      <div class="col-md-6">
        <div class="btn-group">
          
          <a class="btn btn-primary btn-sm" href="/2014-05/read_notes.html" title="自然数和数论">&laquo; Prev</a>
          
          <a class="btn btn-primary btn-sm" href="/archive.html">Archive</a>
          
          <a class="btn btn-primary btn-sm" href="/2014-05/machinelearning.html" title="监督学习:线性回归">Next &raquo;</a>
          
        </div>
      </div>
      <div class="col-md-6 visible-lg visible-md">
      

      </div>
    </div>
    
<div id="comments">
  <div class="ds-thread" data-thread-key="/2014-05/python0"  data-title="python的闭包和修饰器 - shengxc's blog"></div>
</div>


  </article>

  <aside class="col-md-3 visible-lg visible-md">
          <!--      <section>
        <h4>Categories</h4>
        <div class="tag_box">
          <ul>
          
          


  
    
  

 
          </ul>
        </div>
      </section>
-->

            <section>
        <h4>Recently Posts</h4>
        <ul>
        
          <li><a href="/2014-06/machinelearning.html">局部加权回归和logistic回归</a></li>
        
          <li><a href="/2014-05/read_notes.html">数学中的数系</a></li>
        
          <li><a href="/2014-05/machinelearning.html">监督学习:线性回归</a></li>
        
          <li><a href="/2014-05/python0.html">python的闭包和修饰器</a></li>
        
          <li><a href="/2014-05/read_notes.html">自然数和数论</a></li>
        
          <li><a href="/2014-05/interview_record.html">零星的面试记忆</a></li>
        
          <li><a href="/2014-05/hello.html">第一篇博客</a></li>
        
        </ul>
      </section>


            
      <section>
        <h4>Recently Comments</h4>
          <ul class="ds-recent-comments" data-num-items="10" data-show-avatars="0" data-show-time="0" data-show-title="0" data-show-admin="0" data-excerpt-length="12"></ul>
      </section>
      


            
      <section>
        <h4>Recently Visitors</h4>
          <ul class="ds-recent-visitors" data-num-items="12" data-avatar-size="45"></ul>
      </section>
      


      <!--      
-->

  </aside>

</div>


      </div>

      <footer class="text-left">
      <p>&copy; 2014 <a href="/" target="_blank"></a>. with Help from <a href="http://jekyllbootstrap.com/" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a> and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a></p>
      </footer>
    </div> <!-- /container -->

    <script src="http://cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>

    <!--BEGIN添加代码美化-->
    <link href="/assets/google-code-prettify/prettify.css" rel="stylesheet" type="text/css" media="all">
    <script type="text/javascript" src="/assets/google-code-prettify/prettify.js"></script>
    <script type="text/javascript">
      $(function(){
      $("pre").addClass("prettyprint linenums");
      prettyPrint();
      });
    </script>
    <!--END添加代码美化-->

    <!--BEGIN 添加MathJax库支持公式显示-->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
      });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!--END 添加MathJax库支持公式显示-->
    

    


  <!-- duoshuo Begin -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"shengxc"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = 'http://static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
<!-- duoshuo End -->





    

    

  </body>
</html>

